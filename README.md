# Калькулятор себестоимости продукции (Money_web)

## Описание проекта

**Money_web** - это веб-приложение на Flask, предназначенное для расчета себестоимости производства электронных изделий. Оно позволяет пользователям создавать, просматривать, редактировать и сохранять расчеты, управлять тарифами на различные производственные операции, а также экспортировать итоговые калькуляции в формат Excel.

Приложение поддерживает аутентификацию пользователей и разделение доступа к некоторым функциям (например, редактирование тарифов).

## Основные возможности

*   **Аутентификация пользователей:** Вход в систему для доступа к функционалу.
*   **Управление расчетами:**
    *   Создание новых расчетов с пошаговым вводом данных.
    *   Просмотр, редактирование и копирование существующих расчетов.
    *   Удаление расчетов.
    *   Поиск расчетов по заказчику, изделию или SAP-коду.
*   **Хранение данных:**
    *   Данные расчетов сохраняются в базе данных SQLite (`calculation.db`).
    *   Ранее использовалось хранение в `.pickle` файлах (частично сохранилась логика для обратной совместимости или миграции).
*   **Управление тарифами и константами:**
    *   Просмотр текущих тарифов на производственные операции.
    *   Редактирование тарифов (защищено паролем). Тарифы и константы хранятся в CSV-файлах (`data/tarifs.csv`, `data/SMD.csv` и т.д.).
*   **Многоэтапный расчет:** Калькуляция включает различные этапы производства:
    *   Подготовка (информация об изделии)
    *   Производственные параметры
    *   SMD-монтаж (с возможностью загрузки BOM/PAP файлов)
    *   Комплектация
    *   THT-монтаж
    *   Волновая пайка
    *   Лакировка HRL
    *   Ручной монтаж
    *   Тестирование
    *   Отмывка
    *   Ручная лакировка
    *   Разделение плат
    *   Рентген-контроль
    *   Упаковка
    *   Дополнительные работы
    *   Итоговая информация (прибыль, НДС)
*   **Экспорт данных:**
    *   Выгрузка итоговой калькуляции в файл Excel (`.xlsx`) с несколькими листами: "Трудозатраты", "Информация", "Черновая ТК".
    *   Скачивание файла базы данных.
*   **Ведение логов:** Запись основных событий и ошибок в файлы `mylog.log` и `app.log`.

## Технологии

*   **Бэкенд:** Python, Flask
*   **База данных:** SQLite
*   **Работа с данными:** Pandas (для обработки CSV и Excel)
*   **Фронтенд:** HTML, Jinja2 (шаблонизатор Flask), CSS, JavaScript (для динамических элементов на страницах)
*   **Аутентификация:** Собственная реализация,

## Структура проекта

*   `main.py`: Основной файл приложения, содержит логику маршрутизации, обработку запросов и управление сессиями.
*   `calculations_money.py`: Модуль с основной логикой расчетов себестоимости.
*   `tables.py`: Модуль для работы с таблицами данных (вероятно, CSV), включая их обновление.
*   `Verification.py`: Модуль для валидации вводимых пользователем данных и автоматического сохранения.
*   `config.py`: Файл конфигурации (например, путь к базе данных).
*   `models.py`: Вероятно, предназначался для моделей SQLAlchemy или других ORM, но его использование в текущей версии `main.py` не ясно.
*   `directories.py`: Модуль для работы со старой файловой структурой расчетов (навигация по каталогам).
*   `data/`: Каталог для хранения CSV-файлов с тарифами и константами.
*   `Calculations/`: Каталог, ранее использовавшийся для хранения `.pickle` файлов с расчетами. Также в нем создается база данных `calculation.db`.
*   `templates/`: Каталог с HTML-шаблонами страниц.
*   `static/`: Каталог для статических файлов (CSS, JS).
*   `requirements.txt`: Список зависимостей проекта.

## Важные замечания и рекомендации

*   **Безопасность:** В коде присутствует жестко закодированный пароль (`password = '1234'`) для доступа к редактированию тарифов. Это **критическая уязвимость**, и пароль должен быть удален из кода и управляться через конфигурационные файлы или переменные окружения с использованием хэширования.
*   **Миграция данных:** Приложение, по-видимому, находится в процессе перехода от хранения данных в `.pickle` файлах к SQLite. Некоторые маршруты (`/Dirs2`, `/get_child_folders`, `/get_sub_folders`) все еще работают со старой файловой системой. Рекомендуется завершить миграцию и удалить устаревший код.
*   **Обработка `eval()`:** Использование `eval()` при загрузке данных из БД (`open_file_db`, `copy_file_db`) потенциально небезопасно. Рекомендуется заменить на `ast.literal_eval` или использовать JSON для сериализации сложных объектов в БД.
*   **Консистентность кода:** Стандартизировать подключение к БД (везде использовать `get_db()`), обработку путей к файлам, именование переменных.
*   **Рефакторинг:** Некоторые функции в `main.py` достаточно объемные и могут быть разделены на более мелкие для улучшения читаемости и поддержки.