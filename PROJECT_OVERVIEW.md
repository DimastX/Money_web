# Обзор проекта "money.contract"

## Введение

Проект "money.contract" представляет собой веб-приложение на Flask, предназначенное для расчета стоимости производства изделий. Он позволяет пользователям вводить различные параметры, такие как данные о заказчике, характеристики изделия, используемые компоненты, технологические операции, и на основе этих данных формировать итоговую калькуляцию. Приложение также включает функционал для сохранения расчетов, их последующего выбора и просмотра, а также управления тарифами. Реализована аутентификация пользователей через LDAP.

## Технологический стек

- **Python**: Основной язык программирования.
- **Flask**: Микрофреймворк для создания веб-приложения.
- **Jinja2**: Шаблонизатор для генерации HTML-страниц.
- **SQLAlchemy**: ORM для взаимодействия с базой данных.
- **SQLite**: Используемая реляционная база данных.
- **Pandas**: Библиотека для обработки и анализа данных, используется при формировании выгрузок.
- **XlsxWriter**: Библиотека для создания Excel-файлов (для экспорта расчетов).
- **LDAP3**: Библиотека для взаимодействия с LDAP-сервером (аутентификация).
- **WTForms**: Библиотека для работы с веб-формами и их валидации.
- **Babel**: Библиотека для интернационализации (хотя явного использования локализации в текущей версии не замечено).
- **HTML/CSS/JavaScript**: Фронтенд-технологии.
- **Bootstrap**: CSS-фреймворк для стилизации интерфейса.

## Структура проекта

```
Money_web/
├── Calculations/             # Директория для сохранения результатов расчетов (Excel-файлы)
├── data/                     # Директория для хранения файлов данных (например, pickle, SQLite БД)
├── Documentation/            # Предполагаемая директория для документации (сейчас пуста)
├── flagged/                  # Директория для "флажков" (файлы, сигнализирующие о выполнении действий)
├── static/                   # Статические файлы (CSS, JS, изображения)
│   └── css/
├── templates/                # HTML-шаблоны Jinja2
│   └── scripts/              # Клиентские JavaScript-файлы
├── .venv/                    # Виртуальное окружение Python
├── __pycache__/              # Кэш Python
├── .cursor/
├── .idea/
├── .supercode/
├── .vscode/
├── app.log                   # Лог-файл приложения
├── calculations_money.py     # Модуль с основной логикой расчетов
├── config.py                 # Конфигурационные параметры (пути и т.д.)
├── directories.py            # Функции для работы с директориями проекта
├── main.py                   # Основной файл приложения Flask (маршруты, контроллеры)
├── models.py                 # Определения моделей SQLAlchemy и логика миграции данных
├── mylog.log                 # Еще один лог-файл (возможно, для отладки)
├── README.md                 # Файл с описанием проекта
├── requirements.txt          # Список зависимостей Python
├── tables.py                 # Функции для создания и обновления таблиц (тарифы, коэффициенты)
├── Verification.py           # Функции валидации данных, автосохранения, аутентификации
└── PROJECT_OVERVIEW.md       # Этот файл
```

## Описание основных файлов и директорий

### Python-модули (`.py`)

- **`main.py`**:
    - Точка входа приложения Flask.
    - Определяет маршруты (URL), обрабатывает HTTP-запросы.
    - Управляет сессиями пользователей.
    - Взаимодействует с другими модулями для выполнения бизнес-логики (расчеты, валидация, работа с БД).
    - Рендерит HTML-шаблоны.

- **`calculations_money.py`**:
    - Содержит основную логику для проведения расчетов стоимости.
    - Включает функции для обработки введенных данных, применения тарифов, расчета промежуточных и итоговых значений.
    - Формирует данные для экспорта в Excel.

- **`tables.py`**:
    - Отвечает за работу с табличными данными, в частности, с тарифами и коэффициентами.
    - Включает функции для чтения, обновления и отображения этих таблиц.

- **`Verification.py`**:
    - Реализует функции для валидации данных, вводимых пользователем в формы.
    - Содержит логику для автосохранения данных форм в сессию.
    - Управляет процессом аутентификации пользователей через LDAP.

- **`config.py`**:
    - Хранит конфигурационные параметры проекта, такие как пути к директориям, настройки базы данных и т.д.

- **`directories.py`**:
    - Предоставляет утилитарные функции для работы с файловой системой проекта (создание директорий, проверка существования файлов и т.п.).

- **`models.py`**:
    - Определяет структуру базы данных с использованием SQLAlchemy (хотя в текущей версии основное внимание уделено миграции из `.pickle` файлов).
    - Содержит скрипты для миграции данных из старых форматов (например, `.pickle`) в базу данных SQLite.

### HTML-шаблоны (`templates/`)

- **`Start.html`**: Страница, предоставляющая навигацию к основным функциям: просмотр каталога изделий, начало нового расчета или скачивание базы данных.
- **`home.html`**: Начальная страница для ввода основных данных нового расчета (Заказчик, Изделие, Количество и т.д.).
- **`second.html`**: Страница для ввода детализированных параметров расчета (комплектация, производство, трафареты, размеры ПП, стоимости и т.д.).
- **`session_data.html`**: Страница для отображения итоговых таблиц с результатами расчета. Позволяет сохранить расчет или выгрузить его в Excel.
- **`tariffs.html`**: Страница для отображения и редактирования (при наличии пароля) таблиц с тарифами.
- **`select_calculation.html` / `select_calculation2.html`**: Страницы для выбора ранее сохраненных расчетов из списка. Позволяют фильтровать по заказчику, изделию, номеру SAP.
- **`login.html`**: Страница аутентификации пользователя.
- **`misc.html`**: Содержит различные HTML-фрагменты, используемые для выбора количества сторон (SMD, THT, лакировка) и опции селективной пайки.
- **`Dirs.html`**: Страница каталога изделий с трехуровневой системой выбора (Заказчик -> Изделие -> Файл расчета). Позволяет открыть изделие или скачать расчет. Использует JavaScript для динамического обновления выпадающих списков.
- **`Dirs2.html`**: Страница для отображения списка изделий (файлов расчетов) в табличном виде с возможностью сортировки по дате и фильтрации по диапазону дат. Предоставляет действия: скопировать, открыть, скачать, удалить расчет. Показывает, заключен ли договор.
- **`Dirsonly.html`**: Страница для навигации по каталогу, отображающая только директории (папки) для выбора.
- **`Cust.html`**: Форма для добавления нового заказчика.
- **`edittable.html`**: Общий шаблон для отображения и редактирования таблицы с двумя столбцами, где второй столбец является редактируемым полем ввода. Используется на различных страницах для изменения данных (например, тарифы).
- **`Info.html`**: Страница для ввода и отображения информации о прибыльности расчета (процент прибыли, НДС) и других общих стоимостных параметров. Позволяет редактировать некоторые значения при наличии пароля.
- **`HRL.html`**: Страница для ввода данных и расчета стоимости селективной лакировки HRL. Позволяет выбрать тип лакировки (одно/двусторонняя), отображает детализированные расчеты стоимости (время, стоимость ПУ/партии, переналадка, ремонт, контроль). Содержит таблицу с тарифами для селективной влагозащиты, редактируемую по паролю.
- **`SMD.html`**: Страница для ввода параметров и расчета стоимости автоматического поверхностного монтажа (SMT). Позволяет указать количество компонентов/наименований для сторон Top/Bot (вручную или через загрузку PAP/BOM), использовать время по симуляции. Отображает детализированные расчеты стоимости (сборка, переналадка, ремонт, контроль) для каждой стороны и общие итоги. Содержит таблицу с тарифами SMT, редактируемую по паролю.
- **`Sep.html`**: Страница для ввода данных и расчета стоимости разделения плат. Позволяет выбрать способ разделения (скрайбирование, перемычки, SAR) и указать количество перемычек. Отображает расчеты стоимости и времени. Содержит таблицу с тарифами на разделение, редактируемую по паролю.
- **`Pack.html`**: Страница для ввода параметров упаковки изделий. Позволяет выбрать тип короба и плёнки, задать размеры, а также рассчитать итоговую стоимость упаковки для одной платы и всей партии. Содержит таблицу с тарифами на упаковку, которую можно редактировать при наличии пароля.
- **`Handv.html`**: Страница для ввода параметров и расчета стоимости ручной лакировки. Позволяет выбрать способ нанесения (окунание, кисть, краскопульт), задать размеры области лакировки и время на подготовительные работы. Отображает детализированные расчеты (время, стоимость на ПУ/партию, контроль). Содержит таблицу с тарифами на ручную лакировку, редактируемую по паролю.
- **`Hand.html`**: Страница для ввода параметров и расчета стоимости ручного монтажа (пайки). Позволяет указать количество точек пайки, отображает итоговую стоимость для одной платы и всей партии, а также детализированные параметры (время, стоимость пайки, контроль). Содержит таблицу с тарифами на ручной монтаж, редактируемую по паролю.
- **`Xray.html`**: Страница для ввода параметров и расчета стоимости рентген-контроля. Позволяет задать процент выборки, выбрать тип изделия (Серверная/Материнская плата, Прочее) и, для типа "Прочее", указать время на компонент и их количество. Отображает детализированные данные по стоимости (количество МЗ, запусков, время, стоимость на ПУ/партию). Содержит таблицу с тарифами на рентген-контроль, редактируемую по паролю.
- **`Comp.html`**: Страница для ввода параметров и расчета стоимости операций, связанных с комплектацией. Позволяет ввести количество наименований по накладной и выбрать тип изделия (различные размеры плат). Отображает детализированные данные по стоимости приемки, входного/выходного контроля и отгрузки (время, стоимость на ПУ/партию). Содержит таблицу с тарифами на контроль комплектации, редактируемую по паролю.
- **`Wave.html`**: Страница для ввода параметров и расчета стоимости волновой пайки. Позволяет указать количество компонентов, оснасток, тип платы (материнская/серверная или прочее), использовать время по симуляции. Отображает детализированные данные по стоимости (набивка, сборка, переналадка, ремонт, контроль - время, стоимость на ПУ/партию) для каждой стороны и для всего ПУ. Содержит таблицу с тарифами на волновую пайку, редактируемую по паролю.
- **`THT.html`**: Страница для ввода параметров и расчета стоимости селективной пайки THT компонентов. Позволяет выбрать одностороннюю или двустороннюю пайку. Для каждой стороны можно выбрать способ расчета времени: ручной ввод (количество компонентов до/более 10 рядов точек пайки, количество DDR/PCI разъемов) или данные симуляции. Отображает детализированные данные по стоимости (набивка, сборка, переналадка, ремонт, контроль - время, стоимость на ПУ/партию) для каждой стороны и для всего ПУ. Содержит таблицу с тарифами на селективную пайку, редактируемую по паролю.
- **`Clear.html`**: Страница для ввода параметров и расчета стоимости отмывки плат. Позволяет выбрать программу отмывки (Укороченная/Полная). Отображает детализированные данные по стоимости (количество компонентов/заготовок/плат, время, стоимость на ПУ/партию, контроль). Содержит таблицу с тарифами на отмывку, редактируемую по паролю.
- **`Add.html`**: Страница для ввода информации о дополнительных работах. Позволяет добавить до трех дополнительных операций, указав их описание, участок выполнения, время на одну плату (ПУ). Отображает расчетное время и стоимость как для одной платы, так и для всей партии.
- **`templates/scripts/*.js`**: Клиентские скрипты для интерактивности (фильтрация, динамическое отображение/скрытие элементов, простые расчеты на клиенте).

### Директории данных

- **`Calculations/`**: Здесь сохраняются Excel-файлы с результатами выполненных расчетов.
- **`data/`**: Хранит файлы данных, используемые приложением, включая базу данных SQLite (`base.db`, `work_centers.db`) и, возможно, архивные `.pickle` файлы.
- **`flagged/`**: Используется для хранения "флагов" - пустых файлов, наличие которых может сигнализировать о завершении определенных операций или состояний.

## Процесс работы пользователя (упрощенно)

1.  Пользователь открывает главную страницу (`/` -> `home.html`).
2.  Вводит начальные данные (заказчик, изделие и т.д.).
3.  Переходит на следующую страницу (`/second` -> `second.html`) для ввода подробных параметров.
4.  После ввода всех данных система производит расчет.
5.  Результаты отображаются на странице (`/session_data` -> `session_data.html`).
6.  Пользователь может сохранить расчет или выгрузить его в Excel.
7.  Существует возможность просмотреть/редактировать тарифы (`/tariffs` -> `tariffs.html`, доступ к редактированию по паролю).
8.  Пользователь может загрузить ранее сохраненный расчет через страницу выбора (`/select_calculation` или `/select_calculation2`).
9.  Для доступа к некоторым функциям (например, редактирование тарифов, возможно, сохранение) требуется аутентификация (`/login` -> `login.html`).

## Дальнейшее развитие (возможные направления)

-   Полный переход на использование SQLAlchemy для всех данных, отказ от `.pickle` файлов.
-   Улучшение пользовательского интерфейса и UX.
-   Более детальное логирование действий пользователя и ошибок.
-   Разработка системы управления пользователями и ролями (если требуется).
-   Рефакторинг JavaScript кода для устранения дублирования и улучшения читаемости.
-   Добавление тестов.

Этот документ предоставляет высокоуровневое описание проекта "money.contract". Для более детального понимания необходимо изучать исходный код и комментарии в нем. 